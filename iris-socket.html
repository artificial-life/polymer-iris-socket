<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iris-polymer-importer/iris-importer.html">

<link rel="import" href="socket-scripts.html">

<dom-module id="iris-socket">
  <template>
  </template>

  <script>
    (function() {
      'use strict'

      let request_timeout = 5000;

      function request() {
        let resolve;
        let reject;
        let promise = (new Promise((res, rej) => {
          resolve = res;
          reject = rej;
        })).timeout(request_timeout);

        return {
          promise: promise,
          resolve: resolve,
          reject: reject
        }
      }

      function SocketConnectionMethod(server, port) {
        if (server.indexOf('http') !== 0) server = 'http://' + server;
        let emitter = new EventEmitter2({
          wildcard: true,
          newListener: false
        });

        let awaits = [];
        let rid = 0;
        let socket = false;
        let auth_token = false;
        let auth_resolve;
        let auth_reject;
        let ready;
        let rooms_cb = {};
        let room_map = {}; //@NOTE: {event_name : room_name}

        return {
          name: "socket",
          lazyInit: function() {
            if (socket) return auth_resolve(true);

            socket = io.connect(server + ':' + port);
            socket.on('connect', () => {
              socket.emit('message', {
                uri: '/auth',
                token: auth_token
              });
            });

            socket.on('disconnect', (r) => {
              console.log('disconnected, so sad', r);
            });

            socket.on('auth-accepted', () => {
              auth_resolve(true);
              console.log('auth accepted');
            });

            socket.on('message', (data) => {
              if (data && data.request_id && awaits[data.request_id]) {
                let rid = data.request_id;
                let request = awaits[rid];

                if (request.promise.isPending())
                  return data.state ? request.resolve(data.value) : request.reject(data.reason);
              }
            });


            socket.on('event', (event) => emitter.emit(event.name, event.data));
          },
          close: function() {
            socket.disconnect();
            socket = false;
          },
          auth: function(token) {
            auth_token = token;

            ready = new Promise(function(res, rej) {
              auth_resolve = res;
              auth_reject = rej;
            }).timeout(request_timeout, 'operation timeout');

            ready.catch(() => {
              console.log('connection closed');
              this.close();
            });

            this.lazyInit();

            return ready;
          },
          request: function(uri, data) {
            return ready.then(() => {
              data = data || {};
              console.log('request', uri, data);
              rid = (rid + 1) % 10000;
              data.request_id = rid;

              socket.emit('message', {
                uri: uri,
                data: data || {},
                request_id: rid
              });

              awaits[rid] = new request();
              return awaits[rid].promise;
            });
          },
          subscribe: function(uri, callback) {
            return this.request('/subscribe', {
              event: uri
            }).then((data) => {
              emitter.on(uri, callback);
            });
          },
          unsubscribe: function(uri, callback) {
            return this.request('/unsubscribe', {
              event: uri
            }).then((data) => {
              emitter.off(uri, callback);
            });
          }
        };
      }


      Polymer({
        is: 'iris-socket',
        properties: {},
        getMethod(server, port) {
          if (this.method) return this.method;
          this.method = new SocketConnectionMethod(server, port)
          return this.method;
        }
      });
    })();
  </script>

</dom-module>